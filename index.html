<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BUNKER CAFE - POS</title>

<style>
  body {
    background-color: #000;
    color: #f5f5f5;
    font-family: 'Poppins', sans-serif;
    margin: 0; padding: 0;
  }

  header {
    background: linear-gradient(90deg, #111, #222);
    color: gold;
    text-align: center;
    padding: 18px;
    font-size: 1.5em;
    letter-spacing: 2px;
    border-bottom: 1px solid gold;
  }

  .topnav {
    display: flex;
    justify-content: center;
    gap: 10px;
    background: #111;
    padding: 10px;
    border-bottom: 1px solid gold;
  }

  .topnav button {
    background: #222;
    color: gold;
    border: 1px solid gold;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.3s;
  }

  .topnav button:hover,
  .topnav button.active {
    background: gold;
    color: black;
  }

  .container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 10px;
  }

  .section {
    border: 1px solid gold;
    background: #111;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 25px;
  }

  h2 {
    text-align: center;
    color: gold;
  }

  /* üñ§ GLOBAL BUNKER THEME */
body {
  background: #000;
  color: #ffd700;
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 20px;
  text-align: center;
}

/* SECTION HEADINGS */
h2 {
  color: #fff16b;
  text-shadow: 0 0 12px #ffd700, 0 0 24px rgba(255, 215, 0, 0.6);
  font-size: 28px;
  letter-spacing: 1px;
  margin-bottom: 20px;
}
/* üß± BASE LAYOUT */
body {
  background: #000;
  color: #ffd700;
  font-family: 'Poppins', sans-serif;
  text-align: center;
}

/* ‚ö° FILTERS */
.filters {
  margin: 15px auto 25px;
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
}

.filters select,
.filters input {
  background: rgba(20, 20, 20, 0.9);
  border: 1px solid #ffb300;
  border-radius: 8px;
  color: #ffdd66;
  padding: 8px 14px;
  font-size: 15px;
  transition: all 0.3s ease;
  box-shadow: 0 0 6px rgba(255, 179, 0, 0.3);
}

.filters select:focus,
.filters input:focus {
  outline: none;
  box-shadow: 0 0 18px #ffb300, 0 0 35px rgba(255, 179, 0, 0.5);
  transform: scale(1.03);
}

/* ‚ö° POS LAYOUT */
.pos-layout {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 25px;
}

/* üßæ MENU SECTION */
.menu-section {
  flex: 1 1 80%;
  display: flex;
  justify-content: center;
}

/* üü® MENU GRID */
.menu-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 18px;
  width: 90%;
  margin: 0 auto;
}

/* üçØ MENU ITEM CARD */
.menu-item {
  background: linear-gradient(145deg, #111, #000);
  border: 1px solid rgba(255, 179, 0, 0.5);
  border-radius: 14px;
  padding: 15px;
  color: #ffdd66;
  cursor: pointer;
  transition: all 0.25s ease-in-out;
  box-shadow: 0 0 12px rgba(255, 179, 0, 0.15);
  text-align: center;
}

/* üü° HOVER EFFECT ‚Äî Amber Pulse */
.menu-item:hover {
  transform: scale(1.08);
  box-shadow: 0 0 25px #ffb300, 0 0 40px rgba(255, 179, 0, 0.5);
  background: linear-gradient(145deg, #1a1a1a, #000);
}

/* ‚ú® ACTIVE ITEM (selected) */
.menu-item.active {
  border: 1px solid #ffb300;
  box-shadow: 0 0 25px #ffb300, 0 0 45px rgba(255, 179, 0, 0.6);
  transform: scale(1.12);
  animation: amberPulse 1.4s infinite alternate;
}

/* üåÄ Pulse Animation */
@keyframes amberPulse {
  from { box-shadow: 0 0 15px #ffb300; }
  to { box-shadow: 0 0 35px #ffb300, 0 0 55px rgba(255, 179, 0, 0.6); }
}

/* üè∑ ITEM TITLE */
.menu-item h4 {
  margin: 10px 0 5px;
  font-size: 18px;
  text-shadow: 0 0 8px rgba(255, 179, 0, 0.4);
}

/* üí∞ PRICE TAG */
.menu-item .price {
  font-size: 16px;
  color: #fff16b;
  text-shadow: 0 0 6px #ffb300;
}

/* üîò BUTTONS */
button {
  background: linear-gradient(90deg, #ffb300, #ffd54f);
  color: #000;
  font-weight: bold;
  padding: 10px 18px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.25s ease-in-out;
  box-shadow: 0 0 12px rgba(255, 179, 0, 0.3);
}

button:hover {
  transform: scale(1.08);
  background: linear-gradient(90deg, #ffd54f, #ffb300);
  box-shadow: 0 0 20px #ffb300, 0 0 40px rgba(255, 179, 0, 0.6);
}

/* üîí LOGOUT BUTTON (Dark Gold Glow) */
.logout-btn {
  float: right;
  margin-right: 10px;
  background: linear-gradient(90deg, #000, #111);
  border: 1px solid #ffb300;
  color: #ffb300;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(255, 179, 0, 0.3);
}

.logout-btn:hover {
  background: linear-gradient(90deg, #111, #000);
  color: #fff16b;
  box-shadow: 0 0 25px #ffb300, 0 0 50px rgba(255, 179, 0, 0.6);
  transform: scale(1.05);
}



  

  .cart {
    background: #111;
    border: 1px solid gold;
    border-radius: 10px;
    padding: 10px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    color: #ddd;
    margin-top: 10px;
  }

  th, td {
    border: 1px solid #222;
    padding: 6px;
    text-align: center;
  }

  th {
    background: gold;
    color: black;
  }

  

  .actions button {
    background: gold;
    color: black;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: bold;
    cursor: pointer;
  }

  @media print {
    body { background: #fff; color: #000; font-family: monospace; font-size: 13px; }
    .no-print { display: none; }
    h2 { font-size: 1em; margin: 4px 0; text-align: center; }
    hr { border: none; border-top: 1px dashed #000; margin: 6px 0; }
    .bold { font-weight: bold; }
  }

  .pos-layout {
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }

  .menu-section { flex: 2; }
  .cart-section { flex: 1; }

  @media (max-width: 768px) {
    .pos-layout { flex-direction: column; }
  }
  .menu-item {
  border-radius: 10px;
  padding: 10px;
  background: #111;
  text-align: center;
  transition: 0.3s;
  position: relative;
  box-shadow: 0 0 4px rgba(255, 255, 255, 0.1);
}



    h1 {
      margin-top: 20px;
      color: #fff16b;
      text-shadow: 0 0 10px #ffd700;
    }
    button.logout-btn {
  float: right;
  margin-right: 10px;
  background: linear-gradient(90deg, #ffd700, #fff16b);
  border: none;
  color: #000;
  font-weight: bold;
  padding: 10px 18px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.25s ease-in-out;
  box-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
}

button.logout-btn:hover {
  transform: scale(1.08);
  box-shadow: 0 0 15px gold, 0 0 25px rgba(255, 215, 0, 0.6);
  background: linear-gradient(90deg, #fff16b, #ffd700);
}


</style>
</head>
<body>
  <button onclick="logout()" style="float:right;margin-right:10px;">Logout</button>
<header><h1>üñ§ THE BUNKER CAFE LUMS üñ§</h1></header>



<div class="topnav">
  <button class="active" onclick="switchTab('pos',this)"><h3>üß∫üß∫üß∫MENU</h3></button>
  <button onclick="switchTab('reports',this)"><h3>üíºREPORTS</h3></button>
  <button onclick="switchTab('handover',this)"><h3>üí∏üíµCASH HAND OVER</h3></button>
  <button id="btnUserManager" onclick="window.location.href='user-manager.html'"><h3>üïµ User Manager</h3></button>

</div>

<div class="container">

<!-- POS TAB -->
<div id="tab-pos" class="section" style="display:block;">
  <h2>üí∏ POINT OF SALE</h2>

  <div class="filters">
    <select id="categorySelect" onchange="renderMenu()">
      <option value="">All Categories</option>
    </select>
    <input id="search" placeholder="Search..." oninput="renderMenu()">
  </div>

  <div class="pos-layout">
    <!-- MENU -->
    <div class="menu-section">
      <div class="menu-grid" id="menuItems"></div>
    </div>

    <!-- RECEIPT -->
    <div class="cart-section">
      <div class="cart">
        <h3 style="color:gold;">üßæ RECEIPT</h3>
        <table id="receipt-items">
          <thead><tr><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
          <tbody id="receipt-body"></tbody>
        </table>

        <div id="receipt-total" style="margin-top:8px;text-align:right;font-weight:bold;display:flex;justify-content:space-between;">
          <span>Total:</span><span id="receipt-total-value">‚Ç®0</span>
        </div>
        <div>
          <label>Cashier:</label>
          <input id="cashier" placeholder="Enter cashier name"
            style="width:100%;background:#000;color:gold;border:1px solid gold;padding:4px;border-radius:5px;">
        </div>

        <div style="margin-top:8px;">
          <label>Payment Type:</label>
          <select id="paymentType" onchange="onPaymentTypeChange()">
            <option>Cash</option>
            <option>Online</option>
          </select>
        </div>

        <div style="margin-top:8px;">
          <label>Order Shift:</label>
          <select id="orderShift">
            <option value="Morning">Morning</option>
            <option value="Evening">Evening</option>
            
          </select>
        </div>

        <div id="cashReceivedLabel" style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
          <label>Cash Received:</label>
          <input id="cashReceived" type="number" value="0" oninput="updateChange()"
            style="width:100px;background:#000;color:gold;border:1px solid gold;padding:4px;border-radius:5px;">
        </div>

        <div style="margin-top:6px;text-align:right;">
          Change: <span id="changeValue">RS0</span>
        </div>

        <div class="actions" style="margin-top:10px;display:flex;gap:8px;justify-content:space-between;">
          <button onclick="saveOrder()">Save</button>
          <button onclick="printReceipt()">Print</button>
          <button onclick="clearCart()">Clear</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- REPORTS TAB -->
<div id="tab-reports" class="section">
  <h2>üìä SALES REPORT</h2>
  <div class="filters">
    <input type="date" id="reportDate" onchange="renderReports()">
    <select id="reportShift" onchange="renderReports()">
      <option value="">All Shifts</option>
      <option>Morning</option><option>Evening</option>
    </select>
    <select id="reportPayment" onchange="renderReports()">
      <option value="">All Payments</option>
      <option>Cash</option><option>Online</option>
    </select>
    <select id="reportCategory" onchange="renderReports()">
      <option value="">All Categories</option>
    </select>
    <input id="reportItem" oninput="renderReports()" placeholder="Search item">
    <select id="viewMode" onchange="renderReports()">
      <option value="item">Item-wise</option>
      <option value="order">Order-wise</option>
    </select>
  </div>

  <section id="itemView">
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Time</th><th>Shift</th><th>Category</th>
          <th>Item</th><th>Qty</th><th>Total</th><th>Payment</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
      <tfoot>
        <tr><td colspan="5">TOTAL</td><td id="totalQty">0</td><td id="totalSales">‚Ç®0</td><td>-</td></tr>
      </tfoot>
    </table>
  </section>

  <section id="orderView" style="display:none;">
    <table>
      <thead><tr><th>Order ID</th><th>Date</th><th>Cashier</th><th>Items</th><th>Total</th><th>Payment</th></tr></thead>
      <tbody id="orderContainer"></tbody>
    </table>
  </section>
</div>

<!-- HANDOVER TAB -->
<div id="tab-handover" class="section">
  <h2>üí∞ CASH HAND OVER</h2>

  <div class="filters">
    <label>Date:</label>
    <input type="date" id="handoverDate" value="">
    <label>Shift:</label>
    <select id="handoverShift"><option>Morning</option><option>evning</option></select>
  </div>

  <label>Cashier</label><input id="handoverCashier">
  <label>Receiver</label><input id="handoverReceiver">
  <label>Amount</label><input id="handoverAmount" type="number">

  <div class="actions" style="margin-top:10px;">
    <button onclick="addHandover()">Submit</button>
    <button onclick="exportHandoverCSV()">Export CSV</button>
  </div>

  <table style="margin-top:15px;">
    <thead><tr><th>Date</th><th>Cashier</th><th>Receiver</th><th>Amount</th><th>Shift</th></tr></thead>
    <tbody id="handoverBody"></tbody>
  </table>
  <h4 style="text-align:right;">Total: <span id="handoverTotal">‚Ç®0</span></h4>
</div>
<script type="module">
/* ========== BUNKER CAFE - FIREBASE ROLE SYSTEM (Firestore Based) ========== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";


/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC-DRIdb__0Exl2K45YJ0zFlbhPbi9KU-A",
  authDomain: "bunker-cafe.firebaseapp.com",
  projectId: "bunker-cafe",
  storageBucket: "bunker-cafe.firebasestorage.app",
  messagingSenderId: "2914597895",
  appId: "1:2914597895:web:73b2173d2fc965a5593ea2",
  measurementId: "G-89HZV2XMZR"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
window.db = db;

console.log("üî• Firebase connected (Firestore Role System Active)");

/* ===== AUTH CHECK + FIRESTORE ROLE FETCH ===== */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  console.log("‚úÖ Logged in as:", user.email);

  // --- Get Role From Firestore ---
  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  let role = "cashier"; // default if not found

  if (userSnap.exists()) {
    role = userSnap.data().role || "cashier";
    console.log("üé≠ Role from Firestore:", role);
  } else {
    console.warn("‚ö†Ô∏è No role document found for:", user.email);
    alert("‚ö†Ô∏è Access denied ‚Äî no role assigned. Contact admin.");
    await signOut(auth);
    window.location.href = "login.html";
    return;
  }

  window.userRole = role;

  // ‚úÖ Role-based UI Control
  const reportBtn = document.querySelector('button[onclick*="reports"]');
  const reportTab = document.getElementById("tab-reports");
  const handoverTab = document.getElementById("tab-cash");
  const userManagerBtn = document.getElementById("btnUserManager"); // üëà NEW button (admin only)

  if (role === "admin") {
    // Admin ‚Üí all visible
    if (reportBtn) reportBtn.style.display = "inline-block";
    if (reportTab) reportTab.style.display = "block";
    if (handoverTab) handoverTab.style.display = "block";
    if (userManagerBtn) userManagerBtn.style.display = "inline-block"; // show User Manager
  } else if (role === "cashier") {
    // Cashier ‚Üí hide reports & user manager
    if (reportBtn) reportBtn.style.display = "none";
    if (reportTab) reportTab.style.display = "none";
    if (handoverTab) handoverTab.style.display = "block";
    if (userManagerBtn) userManagerBtn.style.display = "none";
  }

  // ‚úÖ Default tab after login
  if (typeof switchTab === "function") {
    const posBtn = document.querySelector('button[onclick*="pos"]');
    switchTab("pos", posBtn);
  }
});

/* ===== LOGOUT FUNCTION ===== */
window.logout = () => {
  signOut(auth).then(() => {
    console.log("üö™ Logged out successfully");
    window.location.href = "login.html";
  });
};





/* ---------------- MENU ITEMS ---------------- */
const MENU_ITEMS = [
  {name:'Green Tea',price:80,category:'Tea'},
  {name:'Milk Tea',price:100,category:'Tea'},
  {name:'Espresso',price:180,category:'Coffee'},
  {name:'Americano',price:180,category:'Coffee'},
  {name:'Cappuccino/Latte',price:280,category:'Coffee'},
  {name:'Spanish Latte',price:330,category:'Coffee'},
  {name:'French Vanilla Latte',price:330,category:'Coffee'},
  {name:'Dark Mocha Latte',price:330,category:'Coffee'},
  {name:'Lush Caramel Latte',price:330,category:'Coffee'},
  {name:'Roasted Hazelnut Latte',price:330,category:'Coffee'},
  {name:'Cinnamon Spice Latte',price:330,category:'Coffee'},
  {name:'Sticky Toffee Latte',price:330,category:'Coffee'},
  {name:'Iced Americano',price:200,category:'Iced Coffee'},
  {name:'Iced Latte',price:300,category:'Iced Coffee'},
  {name:'Iced Spanish Latte',price:380,category:'Iced Coffee'},
  {name:'Iced Vanilla Latte',price:380,category:'Iced Coffee'},
  {name:'Iced Mocha Latte',price:380,category:'Iced Coffee'},
  {name:'Iced Caramel Latte',price:380,category:'Iced Coffee'},
  {name:'Iced Hazelnut Latte',price:380,category:'Iced Coffee'},
  {name:'Iced Cinnamon Latte',price:380,category:'Iced Coffee'},
  {name:'Iced Toffee Latte',price:380,category:'Iced Coffee'},
  {name:'Peach Iced Tea',price:180,category:'Iced Tea'},
  {name:'Lemon Iced Tea',price:180,category:'Iced Tea'},
  {name:'Strawberry Iced Tea',price:180,category:'Iced Tea'},
  {name:'Passion Fruit Lemonade',price:200,category:'Lemonade'},
  {name:'Strawberry Lemonade',price:200,category:'Lemonade'},
  {name:'Mint Lemonade',price:200,category:'Lemonade'},
  {name:'Blue Ocean Lemonade',price:200,category:'Lemonade'},
  {name:'Virgin Vanilla',price:430,category:'Frappe'},
  {name:'Mean Mocha',price:430,category:'Frappe'},
  {name:'Cool Caramel',price:430,category:'Frappe'},
  {name:'Hero Hazelnut',price:430,category:'Frappe'},
  {name:'Banana Shake',price:280,category:'Shake'},
  {name:'Strawberry Shake',price:330,category:'Shake'},
  {name:'Oreo Shake',price:330,category:'Shake'},
  {name:'Chocolate Shake',price:350,category:'Shake'},
  {name:'Lotus Shake',price:350,category:'Shake'},
  {name:'Mango Shake',price:350,category:'Shake'},
  {name:'Power House Shake',price:350,category:'Shake'},
  {name:'Classic Belgian',price:320,category:'Hot Choc'},
  {name:'Banana Hot Choc',price:320,category:'Hot Choc'},
  {name:'Mint Hot Choc',price:320,category:'Hot Choc'},
  {name:'Vanilla Iced Matcha',price:400,category:'Matcha'},
  {name:'Matcha Frappe',price:500,category:'Matcha'},
  {name:'Sunrise',price:350,category:'Smoothie'},
  {name:'Sunset in Paradise',price:350,category:'Smoothie'},
  {name:'Mint Margarita',price:250,category:'Smoothie'},
  {name:'Blueberry',price:150,category:'Slushee'},
  {name:'Strawberry',price:150,category:'Slushee'},
  {name:'Green Apple',price:150,category:'Slushee'},
  {name:'Mix Berry',price:150,category:'Slushee'},
  {name:'Peach',price:150,category:'Slushee'},
  {name:'Cheese Toastie',price:330,category:'Sandwich'},
  {name:'Chicken Panini',price:380,category:'Sandwich'},
  {name:'French Toast',price:300,category:'Breakfast'},
  {name:'Mac and Cheese',price:400,category:'Pasta'},
  {name:'Simple Glazed Donut',price:250,category:'Donut'},
  {name:'choc sprinkle Donut',price:250,category:'Donut'},
  {name:'Boston Cream Donut',price:300,category:'Donut'},
  {name:'Nutella Donut',price:300,category:'Donut'},
  {name:'Red Velvet Donut',price:300,category:'Donut'},
  {name:'Chocolate Fudge Brownie',price:300,category:'Brownie'},
  {name:'Shahbaz Cookie',price:250,category:'Finished Goods'},
  {name:'Shahbaz Brownie',price:250,category:'Finished Goods'},
  {name:'D Cookie',price:450,category:'Finished Goods'},
  {name:'Classic Cookie',price:350,category:'Finished Goods'},
  {name:'Matilda Cake',price:500,category:'Finished Goods'},
  {name:'Nut Bread',price:250,category:'Finished Goods'},
  {name:'Plain Bread',price:230,category:'Finished Goods'},
  {name:'Cup',price:10,category:'Disposable'},
  {name:'Glass',price:10,category:'Disposable'},
  {name:'water',price:60,category:'water'},
];

/* ---------------- STATE & KEYS ---------------- */
let CART = [];
const ORDERS_KEY = 'bunker_orders_v1';
const HANDOVERS_KEY = 'bunker_handovers_v1';

/* ---------------- HELPERS ---------------- */
function $(id){ return document.getElementById(id); }
function currency(n){ return '‚Ç®'+Number(n).toLocaleString('en-PK'); }

function formatDateTime(d){
  const dt = new Date(d);
  return dt.toLocaleString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true});
}

/* ---------------- UI: init/render ---------------- */
document.addEventListener('DOMContentLoaded', () => {
  // Hide reports & handover tabs on POS startup
  $('tab-reports').style.display = 'none';
  $('tab-handover').style.display = 'none';

  // Set default handover date to today
  const today = new Date().toISOString().slice(0,10);
  $('handoverDate').value = today;

  // Initialize POS UI
  initCategories();
  renderMenu();
  renderCart();

  // Start realtime listeners
  startRealtimeOrders();
  startRealtimeHandovers();

  // Initial render (reports + handover)
  renderReports();
  renderHandoverReport();

  // Auto filter listeners
  $('handoverDate').addEventListener('change', renderHandoverReport);
  $('handoverShift').addEventListener('change', renderHandoverReport);
});


function initCategories(){
  const cats=[...new Set(MENU_ITEMS.map(i=>i.category))].sort();
  const sel=$('categorySelect'); const reportSel=$('reportCategory');
  sel.innerHTML = '<option value="">All Categories</option>';
  reportSel.innerHTML = '<option value="">All Categories</option>';
  cats.forEach(c=>{
    const o=document.createElement('option'); o.textContent=c; o.value=c;
    sel.appendChild(o); reportSel.appendChild(o.cloneNode(true));
  });
}

function renderMenu(){
  const q=$('search').value.toLowerCase(), cat=$('categorySelect').value, c=$('menuItems');
  c.innerHTML='';
  MENU_ITEMS.filter(i=>(!cat||i.category===cat)&&(i.name.toLowerCase().includes(q))).forEach(it=>{
    const div=document.createElement('div'); div.className='menu-item';
    const catClass = 'category-' + it.category.replace(/\s/g,'\\ ');
    div.innerHTML=`
      <div class="category-label ${catClass}">${it.category}</div>
      <div style="font-weight:bold;font-size:14px;margin-top:8px;">${it.name}</div>
      <div style="margin-top:6px;font-weight:bold;color:gold;">‚Ç®${it.price}</div>
      <button style="margin-top:6px;" onclick="addToCart('${it.name.replace(/'/g,"\\'")}','${it.price}','${it.category}')">ADD</button>
    `;
    c.appendChild(div);
  });
}

/* ---------------- CART ---------------- */
window.addToCart = function(name,price,category){
  const i = CART.find(x=>x.name===name);
  if(i) i.qty++;
  else CART.push({name,price:+price,qty:1,category});
  renderCart();
};

function setQty(i,v){ if(v<=0) CART.splice(i,1); else CART[i].qty=+v; renderCart(); }
function clearCart(){ if(confirm('Clear cart?')){ CART=[]; renderCart(); } }

function renderCart(){
  const tb=$('receipt-body'); tb.innerHTML=''; let total=0;
  CART.forEach((it,i)=>{
    total+=it.price*it.qty;
    tb.innerHTML+=`<tr><td>${it.name}</td><td><input type="number" value="${it.qty}" min="1" onchange="setQty(${i},this.value)" style="width:50px"></td><td>${currency(it.price*it.qty)}</td></tr>`;
  });
  $('receipt-total-value').textContent = currency(total);
  updateChange();
}

/* ---------------- PAYMENT helpers ---------------- */
function onPaymentTypeChange(){
  const t=$('paymentType').value;
  $('cashReceivedLabel').style.display = t==='Cash' ? 'flex' : 'none';
  if(t!=='Cash') $('cashReceived').value = 0;
  updateChange();
}
function updateChange(){
  const total = Number($('receipt-total-value').textContent.replace(/[‚Ç®,]/g,''))||0;
  const cash = +($('cashReceived').value||0);
  $('changeValue').textContent = currency(Math.max(0,cash-total));
}

/* ---------------- Local storage helpers ---------------- */
function loadLocalOrders(){ return JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]'); }
function saveLocalOrders(arr){ localStorage.setItem(ORDERS_KEY, JSON.stringify(arr)); }
function loadLocalHandovers(){ return JSON.parse(localStorage.getItem(HANDOVERS_KEY)||'[]'); }
function saveLocalHandovers(arr){ localStorage.setItem(HANDOVERS_KEY, JSON.stringify(arr)); }

/* ---------------- FIRESTORE: Realtime listeners ---------------- */

function startRealtimeOrders(){
  try {
    const q = query(collection(db, "orders"), orderBy("date", "desc"));
    onSnapshot(q, snapshot=>{
      const orders = snapshot.docs.map(d=>d.data());
      // save to local for offline usage & fast local queries
      // convert serverTimestamp sentinel for safe local storage: map createdAt to ISO if present
      const safe = orders.map(o => ({...o, createdAt: (o.createdAt && o.createdAt.toDate) ? o.createdAt.toDate().toISOString() : o.createdAt}));
      saveLocalOrders(safe);
      // update UI
      renderReports();
      console.log(`üõ∞Ô∏è Orders updated from Firestore (${orders.length})`);
    }, err=>{
      console.error("Realtime orders error:", err);
    });
  } catch (e) {
    console.error("startRealtimeOrders failed:", e);
  }
}

function startRealtimeHandovers(){
  try {
    const q = query(collection(db, "handovers"), orderBy("date", "desc"));
    onSnapshot(q, snapshot=>{
      const handovers = snapshot.docs.map(d=>d.data());
      const safe = handovers.map(h => ({...h, createdAt: (h.createdAt && h.createdAt.toDate) ? h.createdAt.toDate().toISOString() : h.createdAt}));
      saveLocalHandovers(safe);
      renderHandoverReport();
      console.log(`üõ∞Ô∏è Handovers updated from Firestore (${handovers.length})`);
    }, err=>{
      console.error("Realtime handovers error:", err);
    });
  } catch (e) {
    console.error("startRealtimeHandovers failed:", e);
  }
}

/* ---------------- Save Order (local + cloud + print) ---------------- */
window.saveOrder = async function () {
  if (!CART.length) return alert("‚ö†Ô∏è Cart empty");

  const now = new Date();

  const orderForCloud = {
    id: "ORD" + now.getTime(),
    date: now.toISOString(),
    cashier: $("cashier")?.value || "Unknown",
    payment: $("paymentType")?.value || "Cash",
    shift: $("orderShift")?.value || "Manual",
    items: CART.map(i => ({ ...i })),
    total: CART.reduce((a, b) => a + b.price * b.qty, 0),
    createdAt: serverTimestamp()
  };

  try {
    // Save to Firestore
    await addDoc(collection(db, "orders"), orderForCloud);
    console.log("‚úÖ Order saved to Firebase");

    // Print safely (with data)
    printReceipt(orderForCloud);

    // Clear cart AFTER printing completes
    setTimeout(() => {
      clearCart();
    }, 1000);

    alert("‚úÖ Order saved and printed!");
  } catch (err) {
    console.error("‚ùå Error saving order:", err);
    alert("Error saving order: " + err.message);
  }




  // Local-friendly copy (no Firestore sentinel)
  const orderForLocal = {...orderForCloud, createdAt: now.toISOString() };

  // 1Ô∏è‚É£ Local save
  const localOrders = loadLocalOrders();
  localOrders.unshift(orderForLocal);
  saveLocalOrders(localOrders);

  // 2Ô∏è‚É£ Print immediately using the saved local order data (so print won't depend on CART if we clear)
  await printReceipt(orderForLocal);

  // 3Ô∏è‚É£ Clear cart + redraw
  CART.length = 0;
  requestAnimationFrame(renderCart);

  // 4Ô∏è‚É£ Background Firebase sync (attempt to add cloud copy with serverTimestamp sentinel)
  addDoc(collection(db, "orders"), orderForCloud)
    .then(()=> console.log("‚úÖ Synced to Firebase"))
    .catch(err => console.error("‚ö†Ô∏è Cloud save failed:", err));

  // 5Ô∏è‚É£ Instant user feedback
  toast("Order saved locally ‚ö° (cloud syncing...)", "success");
};

/* ---------------- Save handover (local + cloud) ---------------- */
window.addHandover = async function(){
  const cashier = $('handoverCashier').value.trim();
  const receiver = $('handoverReceiver').value.trim();
  const amount = +$('handoverAmount').value || 0;
  const shift = $('handoverShift').value || 'Unknown';
  const dateISO = new Date().toISOString();

  if(!cashier || !receiver || !amount) return alert('Fill all fields');

  const hCloud = { date: dateISO, cashier, receiver, amount, shift, createdAt: serverTimestamp() };
  const hLocal = { ...hCloud, createdAt: dateISO };

  const local = loadLocalHandovers();
  local.unshift(hLocal);
  saveLocalHandovers(local);

  try {
    await addDoc(collection(db, "handovers"), hCloud);
    alert("Handover saved ‚úî");
  } catch (e) {
    console.error("Firestore addHandover error:", e);
    alert("Handover saved locally (cloud error). Will sync when online.");
  }

  // clear inputs
  $('handoverCashier').value=''; $('handoverReceiver').value=''; $('handoverAmount').value='';
  renderHandoverReport();
};

/* ---------------- Reports rendering (uses localStorage which is kept in sync by realtime) ---------------- */
async function renderReports(){
  const orders = loadLocalOrders();
  const df = $('reportDate').value,
        sf = $('reportShift').value,
        pf = $('reportPayment').value,
        cf = $('reportCategory').value,
        q  = $('reportItem').value.toLowerCase(),
        view = $('viewMode').value;

  const tb = $('reportBody');
  const orderTb = $('orderContainer');
  tb.innerHTML = '';
  orderTb.innerHTML = '';
  let tq = 0, ts = 0;

  const sortedOrders = [...orders].sort((a,b)=>new Date(b.date)-new Date(a.date));

  if(view === 'item'){
    $('itemView').style.display = 'block';
    $('orderView').style.display = 'none';

    const itemMap = new Map();

    sortedOrders.forEach(o=>{
      if(df && o.date.slice(0,10)!==df) return;
      if(sf && o.shift!==sf) return;
      if(pf && o.payment!==pf) return;

      const date = o.date.slice(0,10);
      const time = formatDateTime(o.date).split(' ')[1] || '';

      (o.items||[]).forEach(it=>{
        if(cf && it.category!==cf) return;
        if(q && !it.name.toLowerCase().includes(q)) return;

        const key = it.category + "|" + it.name + "|" + (o.payment||'') + "|" + (o.shift||'');
        if(!itemMap.has(key)){
          itemMap.set(key,{
            date,
            time,
            shift: o.shift,
            category: it.category,
            name: it.name,
            qty: 0,
            total: 0,
            payment: o.payment
          });
        }
        const rec = itemMap.get(key);
        rec.qty += it.qty;
        rec.total += it.price * it.qty;
      });
    });

    const aggregated = Array.from(itemMap.values())
      .sort((a,b)=> a.category.localeCompare(b.category) || a.name.localeCompare(b.name));

    aggregated.forEach(it=>{
      tb.innerHTML += `
        <tr>
          <td>${it.date}</td>
          <td>${it.time}</td>
          <td>${it.shift}</td>
          <td>${it.category}</td>
          <td>${it.name}</td>
          <td>${it.qty}</td>
          <td>${currency(it.total)}</td>
          <td>${it.payment}</td>
        </tr>`;
      tq += it.qty;
      ts += it.total;
    });

    $('totalQty').textContent = tq;
    $('totalSales').textContent = currency(ts);

  } else {
    $('itemView').style.display = 'none';
    $('orderView').style.display = 'block';

    sortedOrders.forEach(o=>{
      if(df && o.date.slice(0,10)!==df) return;
      if(sf && o.shift!==sf) return;
      if(pf && o.payment!==pf) return;

      const date = o.date.slice(0,10);
      const time = formatDateTime(o.date).split(' ')[1] || '';
      const items = (o.items||[]).map(i=>`${i.name} x${i.qty}`).join(', ');
      orderTb.innerHTML += `
        <tr>
          <td>${o.id}</td>
          <td>${date}</td>
          <td>${time}</td>
          <td>${o.cashier||''}</td>
          <td>${items}</td>
          <td>${currency(o.total||0)}</td>
          <td>${o.payment}</td>
          <td>${o.shift}</td>
        </tr>`;
    });
  }
}
/* ---------------- Shift Handling ---------------- */

// Set default shift (restore previous one if saved)
window.addEventListener("DOMContentLoaded", () => {
  const shiftSelect = document.getElementById("orderShift");
  if (!shiftSelect) return;

  // Restore saved shift from localStorage
  const savedShift = localStorage.getItem("bunkerShift");
  if (savedShift) {
    shiftSelect.value = savedShift;
  }

  // Save shift on change
  shiftSelect.addEventListener("change", () => {
    const selectedShift = shiftSelect.value;
    localStorage.setItem("bunkerShift", selectedShift);
    console.log("üïí Shift set to:", selectedShift);
  });
});


/* ---------------- Handover render/export (AUTO FILTER + LIVE UPDATE) ---------------- */
function renderHandoverReport() {
  const list = loadLocalHandovers();
  const tb = $('handoverBody');
  tb.innerHTML = '';
  let t = 0;

  const selectedDate = $('handoverDate').value;
  const selectedShift = $('handoverShift').value;

  const filtered = list
    .filter(h => !selectedDate || h.date.slice(0,10) === selectedDate)
    .filter(h => !selectedShift || h.shift === selectedShift);

  filtered.forEach(h => {
    tb.innerHTML += `
      <tr>
        <td>${formatDateTime(h.date)}</td>
        <td>${h.cashier}</td>
        <td>${h.receiver}</td>
        <td>${currency(h.amount)}</td>
        <td>${h.shift}</td>
      </tr>`;
    t += h.amount;
  });

  $('handoverTotal').textContent = currency(t);
}

/* ---------------- Export handover as CSV ---------------- */
function exportHandoverCSV() {
  const selectedDate = $('handoverDate').value;
  const selectedShift = $('handoverShift').value;

  const list = loadLocalHandovers()
    .filter(h => !selectedDate || h.date.slice(0,10) === selectedDate)
    .filter(h => !selectedShift || h.shift === selectedShift);

  if (!list.length) return alert('No data');

  let csv = 'Date,Cashier,Receiver,Amount,Shift\n';
  list.forEach(h =>
    csv += `${formatDateTime(h.date)},${h.cashier},${h.receiver},${h.amount},${h.shift}\n`
  );

  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'handover.csv';
  a.click();
}


/* ---------------- UI helpers: tab switch ---------------- */
function switchTab(tab,btn){
  document.querySelectorAll('.topnav button').forEach(b=>b.classList.remove('active'));
  btn?.classList.add('active');
  document.querySelectorAll('[id^="tab-"]').forEach(d=>d.style.display='none');
  $('tab-'+tab).style.display='block';
  if(tab==='reports') renderReports();
  if(tab==='handover') renderHandoverReport();
}
window.switchTab = switchTab;

/* ---------------- Print Receipt (works with optional pre-built order) ---------------- */
async function printReceipt(orderParam = null) {
  // If no order param, require CART items
  if(!orderParam && !CART.length) return alert('Cart empty');

  const now = new Date();
  const orderId = orderParam?.id || ('ORD' + Date.now());
  const date = orderParam?.date ? new Date(orderParam.date) : now;
  const formattedDate = formatDateTime(date);
  const items = orderParam?.items || CART;
  const total = orderParam?.total ?? CART.reduce((s, i) => s + i.price * i.qty, 0);
  const cashier = orderParam?.cashier || $('cashier')?.value || 'Unknown';
  const payment = orderParam?.payment || $('paymentType')?.value || 'Cash';
 const shift = orderParam?.shift || document.getElementById('orderShift')?.value || 'Manual';


  // ----- Local save (ensure no serverTimestamp sentinel stored locally) -----
  const orderForLocal = {
    id: orderId,
    date: date.toISOString(),
    cashier,
    payment,
    shift,
    items: items.map(i=>({ ...i })),
    total,
    createdAt: date.toISOString()
  };

  // push to local storage (avoid duplication if same id exists)
  const local = loadLocalOrders();
  if(!local.find(o=>o.id===orderForLocal.id)) {
    local.unshift(orderForLocal);
    saveLocalOrders(local);
  }

  // ----- Try saving to Firebase ----- (non-blocking)
  const orderForCloud = {...orderForLocal, createdAt: serverTimestamp()};
  try {
    await addDoc(collection(db, "orders"), orderForCloud);
    console.log("‚úÖ Order saved to Firestore");
  } catch (e) {
    console.error("‚ö†Ô∏è Firestore error:", e);
    // keep going ‚Äî local copy exists
  }

  // ----- Print view -----
  let html = `
  <html>
  <head>
    <title>Receipt</title>
    <style>
      body { font-family: monospace; font-size: 12px; width: 230px; margin: 0; padding: 2px; }
      h2, h3, .bold { font-weight: bold; text-align: center; margin: 2px 0; }
      .line { display: flex; justify-content: space-between; margin: 1px 0; font-weight: bold; }
      hr { border: none; border-top: 1px dashed #000; margin: 2px 0; }
      .center { text-align: center; font-weight: bold; }
      .spacer { line-height: 10px; }
      .decor { text-align:center; font-weight:bold; letter-spacing:1px; }
      .item { display:flex; justify-content:space-between; }
    </style>
  </head>
  <body>
    <h2>üñ§ BUNKER CAFE üñ§</h2>
    <p class="center">${formattedDate}</p>
    <p class="center" style="font-size:14px;">ORDER ID: ${orderId}</p>
    <hr>
  `;

  items.forEach(item => {
    html += `
      <div style="display:flex;justify-content:space-between;"><div>${item.name}</div><div>‚Ç®${(item.price*item.qty).toLocaleString('en-PK')}</div></div>
      <div style="display:flex;justify-content:space-between;font-size:11px;"><div>Qty: ${item.qty}</div><div>‚Ç®${item.price}</div></div>
    `;
  });

  html += `
    <hr>
    <div style="display:flex;justify-content:space-between;font-weight:bold;"><span>Total</span><span>‚Ç®${total.toLocaleString('en-PK')}</span></div>
    <hr>
    <p class="center">Cashier: ${cashier}</p>
    <p class="center">Payment: ${payment}</p>
    <p class="center">Shift: ${shift}</p>
    <hr>
    <p class="center">Thank You! Visit Again!</p>
  </body>
  </html>
  `;

  const w = window.open('', '_blank', 'width=250,height=600');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
  w.close();

  // If we printed using the live CART, clear it now
  if(!orderParam) {
    CART = [];
    renderCart();
  }
}

window.printReceipt = printReceipt;

/* ---------------- Expose global functions used by HTML ---------------- */
window.setQty = setQty;
window.clearCart = clearCart;
window.onPaymentTypeChange = onPaymentTypeChange;
window.updateChange = updateChange;
window.renderMenu = renderMenu;
window.saveLocalOrders = saveLocalOrders;
window.saveLocalHandovers = saveLocalHandovers;
window.renderReports = renderReports;
window.renderHandoverReport = renderHandoverReport;
window.addHandover = addHandover;
window.exportHandoverCSV = exportHandoverCSV;

// Simple toast fallback
function toast(msg, type='info') {
  try {
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.position = 'fixed';
    el.style.right = '12px';
    el.style.bottom = '12px';
    el.style.background = type==='success' ? 'green' : 'gray';
    el.style.color = 'white';
    el.style.padding = '8px 12px';
    el.style.borderRadius = '6px';
    el.style.zIndex = 9999;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),1);
  } catch(e){ console.log(msg); }
}
window.printReceipt = printReceipt;
window.saveOrder = saveOrder;


</script>

</body>
</html>
