<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BUNKER — USER MANAGER (FAST NAV)</title>
  <style>
    body {
      background: #000;
      color: #ffd700;
      font-family: Poppins, sans-serif;
      text-align: center;
      padding: 0;
      margin: 0;
    }

    /* 🔹 Top Navigation */
    .topnav {
      display: flex;
      justify-content: center;
      gap: 15px;
      background: #111;
      padding: 15px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .topnav button {
      background: linear-gradient(90deg, #ffd700, #fff16b);
      border: none;
      color: #000;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }

    .topnav button:hover {
      box-shadow: 0 0 15px #ffd700;
      transform: scale(1.05);
    }

    h1 {
      margin-top: 20px;
      color: #fff16b;
      text-shadow: 0 0 10px #ffd700;
    }

    table {
      width: 80%;
      margin: 20px auto;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid rgba(255, 215, 0, 0.3);
    }

    select, input {
      background: #111;
      color: #ffd700;
      border: 1px solid #ffd700;
      border-radius: 6px;
      padding: 5px;
    }

    button {
      margin-top: 10px;
      background: linear-gradient(90deg,#ffd700,#fff16b);
      border: none;
      color: #000;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    #msg { margin-top: 10px; color: #fff; }

    #addUser {
      margin: 25px auto;
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 10px;
      width: 60%;
      box-shadow: 0 0 15px rgba(255,215,0,0.2);
        .header {
    background: linear-gradient(90deg, #111, #222);
    color: gold;
    text-align: center;
    padding: 18px;
    font-size: 1.5em;
    letter-spacing: 2px;
    border-bottom: 1px solid gold;
  }

    h1 {
      margin-top: 20px;
      color: #fff16b;
      text-shadow: 0 0 10px #ffd700;
    }
    
  </style>
</head>
<body>
  <header><h1>🖤👑 THE BUNKER CAFE LUMS 🖤</h1></header>
  <div class="topnav">
    <button onclick="window.location.href='index.html'">🧺🧺🧺MENU</button>
    <button onclick="window.location.href='index.html'">💼REPORTS</button>
    <button onclick="window.location.href='index.html#handover'">💸💵CASH HAND OVER</button>
    <button class="active">🕵 USER MANAGER</button>
  </div>

  <h1>👑 BUNKER — USER MANAGER</h1>
  <p>Only admins can access this page.</p>

  <table id="userTable">
    <thead><tr><th>Email</th><th>Role</th><th>Change Role</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="addUser">
    <h3>➕ Add New User</h3>
    <input type="email" id="newEmail" placeholder="User Email"><br>
    <input type="password" id="newPassword" placeholder="Temporary Password"><br>
    <select id="newRole">
      <option value="cashier">cashier</option>
      <option value="admin">admin</option>
    </select><br>
    <button id="createUserBtn">Create User</button>
  </div>

  <button onclick="logout()">Logout</button>
  <div id="msg"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      initializeFirestore, persistentLocalCache,
      collection, getDocs, updateDoc, doc, setDoc
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC-DRIdb__0Exl2K45YJ0zFlbhPbi9KU-A",
      authDomain: "bunker-cafe.firebaseapp.com",
      projectId: "bunker-cafe",
      storageBucket: "bunker-cafe.firebasestorage.app",
      messagingSenderId: "2914597895",
      appId: "1:2914597895:web:73b2173d2fc965a5593ea2",
      measurementId: "G-89HZV2XMZR"
    };

    const app = initializeApp(firebaseConfig);
    const db = initializeFirestore(app, { localCache: persistentLocalCache() });
    const auth = getAuth(app);

    // ✅ Fast Admin Role Check
    onAuthStateChanged(auth, async (user) => {
      if (!user) return (window.location.href = "login.html");

      const usersCol = collection(db, "users");
      const docs = await getDocs(usersCol);
      const current = docs.docs.find(d => d.id === user.uid);

      if (!current || current.data().role !== "admin") {
        document.body.innerHTML = "<h2>🚫 Access Denied</h2>";
        return;
      }

      renderUsers(docs);
    });

    // ✅ Render Users Table
    function renderUsers(snapshot) {
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "";
      snapshot.forEach((docu) => {
        const data = docu.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${data.email}</td>
          <td>${data.role}</td>
          <td>
            <select data-id="${docu.id}">
              <option value="admin" ${data.role === "admin" ? "selected" : ""}>admin</option>
              <option value="cashier" ${data.role === "cashier" ? "selected" : ""}>cashier</option>
            </select>
          </td>`;
        tbody.appendChild(row);
      });

      document.querySelectorAll("select").forEach((sel) => {
        sel.addEventListener("change", async (e) => {
          const userId = e.target.dataset.id;
          const newRole = e.target.value;
          await updateDoc(doc(db, "users", userId), { role: newRole });
          document.getElementById("msg").innerText = `✅ Role updated to "${newRole}"`;
        });
      });
    }

    // ✅ Add New User
    document.getElementById("createUserBtn").addEventListener("click", async () => {
      const email = newEmail.value.trim();
      const password = newPassword.value.trim();
      const role = newRole.value;
      if (!email || !password) return alert("⚠️ Email and password required");

      try {
        const tempApp = initializeApp(firebaseConfig, "temp");
        const tempAuth = getAuth(tempApp);
        const cred = await createUserWithEmailAndPassword(tempAuth, email, password);
        await setDoc(doc(db, "users", cred.user.uid), { email, role });
        await signOut(tempAuth);
        tempApp.delete?.();
        document.getElementById("msg").innerText = `✅ User "${email}" created as ${role}`;
        const docs = await getDocs(collection(db, "users"));
        renderUsers(docs);
      } catch (err) {
        alert("❌ " + err.message);
      }
    });

    // ✅ Logout
    window.logout = () => signOut(auth).then(() => (window.location.href = "login.html"));
  </script>
</body>
</html>
